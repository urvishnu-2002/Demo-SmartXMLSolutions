<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Average Ratings Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        button {
            margin: 10px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            background-color: #007BFF;
            color: white;
            border-radius: 4px;
        }
        button:hover {
            background-color: #0056b3;
        }
        :root{--accent:#1e88e5;--muted:#666}
        body{font-family:Segoe UI,Roboto,Arial,sans-serif;background:#f7f9fc;color:#222;margin:0;padding:24px}
        .container{max-width:900px;margin:0 auto;background:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(18,22,31,0.06)}
        .header{display:flex;align-items:center;justify-content:space-between;gap:16px}
        h1{font-size:1.25rem;margin:0}
        .summary{display:flex;gap:24px;align-items:center}
        .avg-box{padding:16px;border-radius:8px;background:linear-gradient(90deg,rgba(30,136,229,0.06),transparent);min-width:220px}
        .avg-value{font-size:2.4rem;font-weight:700;color:var(--accent);line-height:1}
        .avg-meta{color:var(--muted);font-size:0.95rem;margin-top:6px}
        .stars{color:gold;font-size:1.25rem;margin-top:6px}
        .details{flex:1}
        .total{font-size:1rem;color:var(--muted)}
        .breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:16px}
        .card{background:#fff;border:1px solid #eef2f6;padding:12px;border-radius:8px}
        .rating-label{font-weight:600}
        .count{color:var(--muted);font-size:0.95rem}
        .bar{height:10px;background:#e6eef9;border-radius:6px;margin-top:8px;overflow:hidden}
        .bar > i{display:block;height:100%;background:var(--accent);width:0}
        .no-data{padding:24px;text-align:center;color:var(--muted)}
        @media (max-width:640px){.header{flex-direction:column;align-items:stretch}.summary{flex-direction:column;align-items:flex-start}}
    </style>
</head>
<body>
    <button onclick="location.reload()">Refresh Data</button><br>
    <button onclick="window.history.back()">Go Back</button>
    <div class="container">
        <div class="header">
            <h1>Average Ratings Dashboard</h1>
            <div class="total" id="totalReviews">Total reviews: —</div>
        </div>

        <div class="summary">
            <div class="avg-box">
                <div class="avg-value" id="averageValue">—</div>
                <div class="stars" id="stars">&nbsp;</div>
                <div class="avg-meta" id="avgMeta">Calculated excluding unrated reviews</div>
            </div>

            <div class="details">
                <div class="breakdown" id="breakdown">
                    <!-- rating cards inserted here -->
                </div>
            </div>
        </div>

        <div id="nodata" class="no-data" style="display:none">No reviews available yet.</div>
    </div>

    <script>
        // Data passed in from Flask
        const labels = {{ labels | tojson }};
        const values = {{ values | tojson }};

        // Normalize data into array of {label, count, numeric}
        const items = labels.map((lab, i) => {
            const raw = lab;
            const cnt = Number(values[i]) || 0;
            const numeric = (raw === null || raw === 'None' || raw === 'null') ? null : (Number(raw));
            return { label: raw, count: cnt, numeric };
        });

        // Sum total reviews
        const total = items.reduce((s, it) => s + it.count, 0);

        // Calculate average ignoring unrated (numeric===null)
        let sum = 0, denom = 0;
        items.forEach(it => { if (it.numeric !== null && it.count > 0) { sum += it.numeric * it.count; denom += it.count; } });
        const average = denom > 0 ? (sum / denom) : 0;

        // Update totals and average display
        const totalEl = document.getElementById('totalReviews');
        const avgEl = document.getElementById('averageValue');
        const starsEl = document.getElementById('stars');
        const breakdownEl = document.getElementById('breakdown');
        const nodataEl = document.getElementById('nodata');

        if (total === 0) {
            nodataEl.style.display = 'block';
            totalEl.textContent = 'Total reviews: 0';
            avgEl.textContent = '—';
        } else {
            nodataEl.style.display = 'none';
            totalEl.textContent = `Total reviews: ${total}`;
            avgEl.textContent = denom > 0 ? average.toFixed(2) : 'No rated reviews';

            // Render stars (rounded to nearest half-star visually with full/empty only for simplicity)
            const rounded = Math.round((average || 0) * 2) / 2;
            let starsHtml = '';
            for (let s=1; s<=5; s++){
                if (s <= Math.floor(rounded)) starsHtml += '★';
                else if (s - 0.5 === rounded) starsHtml += '★';
                else starsHtml += '☆';
            }
            starsEl.textContent = starsHtml + (denom>0 ? `  (${denom} rated)` : '');

            // Sort items descending by numeric label (put unrated last)
            const sorted = items.slice().sort((a,b)=>{
                if (a.numeric === null && b.numeric === null) return 0;
                if (a.numeric === null) return 1;
                if (b.numeric === null) return -1;
                return b.numeric - a.numeric;
            });

            // Determine max count for relative bars
            const maxCount = Math.max(...sorted.map(x=>x.count), 1);

            // Render cards
            breakdownEl.innerHTML = '';
            sorted.forEach(it => {
                const label = (it.numeric === null) ? 'Unrated' : String(it.label);
                const pct = Math.round((it.count / maxCount) * 100);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="rating-label">${label}</div>` +
                                 `<div class="count">${it.count} review${it.count!==1?'s':''}</div>` +
                                 `<div class="bar" aria-hidden="true"><i style="width:${pct}%"></i></div>`;
                breakdownEl.appendChild(card);
            });
        }
    </script>
</body>
</html>
